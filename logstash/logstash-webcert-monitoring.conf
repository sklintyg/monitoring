### Input section used for local testing.
#input {
#  file {
#    path => "<path_to_project>/monitoring/logstash/logs/webcert-monitoring*"
#    type => "webcert-monitoring"
#  }
#}
###

filter {
  # Input should add the tag type to be webcert-monitoring for log events from
  # webcert-monitoring.log. This allows us to use specific filters for better
  # parsing.
  if [type] == "webcert-monitoring" {

    # General parsing of message into elements always present in the log
    # messages.
    grok {
      patterns_dir => "$PATTERNS_DIR"
      match => ["message", "%{WEBCERTTIMESTAMP:date} %{SESSION:session} %{USER:user} %{UNIT:unit} %{ORIGIN:origin} %{ROLE:role} - %{DATA:event} %{GREEDYDATA:msg}"]
    }

    # The ISO8601 specification used by Webcert (log4j) differs from logstash
    # ISO8601 which forces us to parse the date seperately.
    date {
      locale => "en"
      match => ["date", "yyyy-MM-dd HH:mm:ss,SSS"]
      target => "@timestamp"
    }

    # Here we use specific parsing to gather more information from specific
    # messages. The filters used are quite specific and if the format of the log
    # message change we will need to change that as well.

    # !!!
    # Make sure that USER_MISSING_MIU_ON_ENHET is caught before USER_MISSING_MIU because 
    # regex pattern matching of USER_MISSING_MIU_ON_ENHET would match even on USER_MISSING_MIU
    # !!!
    if [event] == "USER_MISSING_MIU_ON_ENHET" {
      mutate {
        add_tag => ["AUTH"]
        # We will replace this with the user id specified in the message
        remove_field => ["unit"]
        remove_field => ["user"]
      }
      grok {
        patterns_dir => "$PATTERNS_DIR"
        match => ["msg", "%{WC__AUTH_PARSE}"]
      }
    } else if [event] =~ "USER_(LOG(IN|OUT))|SESSION_EXPIRY|MISSING_MIU" {
      mutate {
        add_tag => ["AUTH"]
        # We will replace this with the user id specified in the message
        remove_field => ["user"]
        remove_field => ["origin"]
      }
      grok {
        patterns_dir => "$PATTERNS_DIR"
        match => ["msg", "%{WC__AUTH_PARSE}"]
      }
    } else if [event] =~ "LOGIN_OTHER_(UNIT|CAREGIVER)" {
      mutate {
        add_tag => ["SJF"]
      }
      grok {
        patterns_dir => "$PATTERNS_DIR"
        match => ["msg", "%{WC__SJF_PARSE}"]
      }
    } else if [event] =~ "PP_TERMS_ACCEPTED" {
      mutate {
        add_tag => ["PLK"]  # PrivatlÃ¤kare
        # We will replace this with the user id specified in the message
        remove_field => ["user"]
      }
      grok {
        patterns_dir => "$PATTERNS_DIR"
        match => ["msg", "%{WC__PP_TERMS_ACCEPTED_PARSE}"]
      }
    } else if [event] =~ "(UTKAST_(CREATED|DELETED|EDITED|PRINT|READ|CONCURRENTLY_EDITED)|INTYG_(READ|REGISTERED|SIGNED|SENT|REVOKED|COPIED|PRINT_PDF))" {
      mutate {
        add_tag => ["INTYG"]
      }
      grok {
        patterns_dir => "$PATTERNS_DIR"
        match => ["msg", "%{WC__INTYG_PARSE}"]
      }
    } else if [event] =~ "(QUESTION|ANSWER)_(SENT|RECEIVED)" {
      mutate {
        add_tag => ["QA"]
        remove_field => ["unit"]
      }
      grok {
        patterns_dir => "$PATTERNS_DIR"
        match => ["msg", "%{WC__QA_PARSE}"]
      }
    } else if [event] =~ "(MEDICINSKT_|)ARENDE_(CREATED|RECEIVED)(_ANSWER|_QUESTION|)" {
      mutate {
        add_tag => ["ARENDE"]
        remove_field => ["unit"]
      }
      grok {
        patterns_dir => "$PATTERNS_DIR"
        match => ["msg", "%{WC__ARENDE_PARSE}"]
      }
    } else if [event] =~ "MAIL_(SENT|MISSING_ADDRESS)" {
      mutate {
        add_tag => ["MAIL"]
      }
      grok {
        patterns_dir => "$PATTERNS_DIR"
        match => ["msg", "%{WC__MAIL_PARSE}"]
      }
    } else if [event] =~ "PU_LOOKUP" {
      mutate {
        add_tag => ["PU"]
      }
      grok {
        patterns_dir => "$PATTERNS_DIR"
        match => ["msg", "%{WC__PU_PARSE}"]
      }
    } else if [event] =~ "NOTIFICATION_SENT" {
      mutate {
        add_tag => ["NOTIFICATION"]
        # We will replace this with the user id specified in the message
        remove_field => ["unit"]
      }
      grok {
        patterns_dir => "$PATTERNS_DIR"
        match => ["msg", "%{WC__NOTIFICATION_PARSE}"]
      }
    } else {
      mutate {
        add_tag => ["OTHER"]
      }
    }
  }
}

### Output section used for testing
#output {
#  if "_grokparsefailure" not in [tags] {
#    elasticsearch { host => localhost }
#    stdout { codec => rubydebug }
#  }
#}
###
